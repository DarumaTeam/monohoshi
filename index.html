<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>IoT-Sentaku</title>
</head>
<body>
<h3 id="volt"></h3>
<h3 id="value"></h3>
<script src="https://mz4u.net/libs/gc2/polyfill.js"></script>
<script type="text/javascript">
var MCP3425 = function(i2cPort,slaveAddress){
  this.i2cPort = i2cPort;
  this.i2cSlave = null;
  this.slaveAddress = slaveAddress;
};
MCP3425.prototype = {
  sleep: function(ms){
    return new Promise((resolve)=>{setTimeout(resolve,ms);});
  },
 
  init: function(){
    return new Promise((resolve, reject)=>{
      this.i2cPort.open(this.slaveAddress).then((i2cSlave)=>{
        this.i2cSlave = i2cSlave;
        console.log("init ok:"+this.i2cSlave);
        resolve();
      },(err)=>{
        reject(err);
      });
    });
  },
 
  compose: function(adc_h,adc_l) {
    var ad_val = adc_l | (adc_h << 8);
    if (ad_val>32767) {
      ad_val = ad_val-65536;
    }
    var volt = ad_val*2.048/32767;
//    var volt = Math.floor(ad_val*1000000*2.048/32767)/1000000;
    return volt;
  },
 
  // read  data
  read: function() {
    return new Promise(async (resolve, reject)=>{
      if(this.i2cSlave == null){
        reject("i2cSlave Address does'nt yet open!");
      }else{
        await this.i2cSlave.writeByte(0x88);
        await this.sleep(100);
        this.i2cSlave.readBytes(2).then((v)=>{                                                                                                                                                                                                                                                                                                                                                                                ;
          var volt = this.compose(v[0],v[1]);
          var value = (v[0] << 8) | v[1];
          resolve({ volt:volt, value:value });
        },(err)=>{
          reject(err);
        });
      }
    });
  }
};
var sum = arr => {
  return arr.reduce((prev, current, i, arr) => {
    return prev + current;
  });
}

var average = (arr, fn) => {
  return sum(arr, fn) / arr.length;
}
var ws = new WebSocket("wss://10.0.128.210:3052/?room=test");
var head = document.querySelector('#head');

  navigator.requestI2CAccess().then((i2cAccess)=>{
    var port = i2cAccess.ports.get(1);
    var adc = new MCP3425(port,0x68);
    adc.init().then(()=>{
      var testdata = null;
      var firstdata = null;
      var values = [];
      var isTest = true;
      setTimeout(async ()=>{
        var test = await adc.read();
        testdata = test.value;
      var timer = setInterval(async ()=>{
        var data = await adc.read().catch(function(reason) {
          console.log("READ ERROR:" + reason);
        });
        if (data.value <= testdata+300 && data.value >= testdata-300 && isTest) {
          values.push(data.value);
        }
        if (values.length === 50 && isTest) {
          firstdata = Math.floor(average(values)) + 1000;
          isTest = false;
          console.log(firstdata);
        }
        if (isTest === false) {
          values.push(data.value);
          if (values.length === 51) {
            values.shift();
          }
          for (var i = 0; i < values.length; i++) {
            if (values[i] <= firstdata) {
              break;
            } else {
              if (i === values.length - 1) {
for (var cnt = 0; cnt < 10; cnt++) {
  setTimeout(() => {
    ws.send("fire");
  }, cnt*1000);
}
                console.log("say!!");
                clearTimeout(timer);
                setTimeout(() => {
                       ws.send("stop");
                    }, 12000);
              }
            }
          }
        }
        
        document.getElementById("volt").textContent = "VIN+ :" + data.volt + " V";
        document.getElementById("value").textContent = data.value;
      },200);
      }, 3000);
    },(err)=>{
      console.log("MCP3425 init error");
    });
 
  }).catch(e=> console.error('error', e));

</script>
</body>
</html>
